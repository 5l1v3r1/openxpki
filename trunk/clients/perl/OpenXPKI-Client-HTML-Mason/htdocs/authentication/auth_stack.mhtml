<%args>
  $msg             => undef
</%args>

    <& '/authentication/open_form.mhtml', 'session_id' => $session_id &>
    <h1><% i18nGettext ('I18N_OPENXPKI_CLIENT_HTML_MASON_GET_AUTHENTICATION_STACK_TITLE') %></h1>
    <p>
      <% i18nGettext ('I18N_OPENXPKI_CLIENT_HTML_MASON_GET_AUTHENTICATION_STACK_DESCRIPTION') %>
    </p>
    <select name="auth_stack">
<%perl>
        ## let's print the available options
        foreach my $stack (keys %{$auth_stacks})
        {
            print "  <option value='$stack'>".
                  $auth_stacks->{$stack}->{NAME}." - ".
                  $auth_stacks->{$stack}->{DESCRIPTION}.
                  "</option>\n";
        }
</%perl>
    </select>
    <& '/authentication/close_form.mhtml' &>

<%init>
    my $session_id = $context->{session_id};
    my $client     = $context->{client};

    ## check that we must handle this message
    return $msg if ($msg->{SERVICE_MSG} ne "GET_AUTHENTICATION_STACK");

    ## was the pki realm specified by the user?
    my %data = $m->request_args();
    if (exists $data{'auth_stack'})
    {
        #print  STDERR "DATA: ".$data{'auth_stack'}."\n";
        $msg = $client->send_receive_service_msg ('GET_AUTHENTICATION_STACK',
                                                  {'AUTHENTICATION_STACK' => $data{'auth_stack'}});
        if ($msg->{'SERVICE_MSG'} ne 'GET_AUTHENTICATION_STACK')
        {
            return $msg;
        }
        #print  STDERR "second: ".$data{'auth_stack'}."\n";
    }

    ## ok let's ask the user for the auth stacks
    ## cache the last message in the context
    my $auth_stacks = $msg->{PARAMS}->{AUTHENTICATION_STACKS};
    $context->{msg} = $msg;
</%init>
