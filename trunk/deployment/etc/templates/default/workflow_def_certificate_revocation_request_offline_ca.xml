<workflow>
  <type>I18N_OPENXPKI_WF_TYPE_CERTIFICATE_REVOCATION_REQUEST_OFFLINE_CA</type>
  <description>I18N_OPENXPKI_WF_DESC_CERTIFICATE_REVOCATION_REQUEST</description>
  <persister>OpenXPKI</persister>
  <observer class="OpenXPKI::Server::Workflow::Observer::Debug"/>

  <!-- ****************************************** -->
  <!--     this is the online part of the CRR     -->
  <!-- ****************************************** -->

  <state name="INITIAL">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_REVOCATION_REQUEST_INITIAL</description>
    <action name="create_crr" 
	    resulting_state="PENDING">
      <condition name="ACL::create_crr"/>
    </action>
  </state>

  <state name="PENDING">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_REVOCATION_REQUEST_PENDING</description>
    <action name="change_crr_invalidity_time"
	    resulting_state="PENDING">
      <condition name="ACL::change_crr_invalidity_time"/>
    </action>
    <action name="change_crr_reason"
	    resulting_state="PENDING">
      <condition name="ACL::change_crr_reason"/>
    </action>
    <action name="approve_crr"
	    resulting_state="APPROVAL">
      <condition name="ACL::approve_crr"/>
    </action>
    <action name="reject_crr"
	    resulting_state="REJECTED">
      <condition name="ACL::reject_crr"/>
    </action>
  </state>

  <state name="APPROVAL">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_REVOCATION_REQUEST_APPROVAL</description>
    <action name="revoke_certificate"
	    resulting_state="REVOKED_CERTIFICATE">
      <condition name="ACL::revoke_certificate"/>
      <condition name="Condition::check_crr_approvals"/>
    </action>
    <!-- perhaps we need more than one approval or                 -->
    <!-- perhaps the first approval was from a not authorized role -->
    <action name="approve_crr"
	    resulting_state="APPROVAL">
      <condition name="ACL::approve_crr"/>
    </action>
    <action name="cancel_crr_approval"
	    resulting_state="PENDING">
      <condition name="ACL::cancel_crr_approval"/>
    </action>
    <action name="reject_crr"
	    resulting_state="REJECTED">
      <condition name="ACL::reject_crr"/>
    </action>
  </state>

  <state name="REVOKED_CERTIFICATE" autorun="yes">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_REVOCATION_REQUEST_REVOKED_CERTIFICATE</description>
    <action name="persist_crr"
	    resulting_state="PERSISTED_CRR">
      <condition name="ACL::insert_crr"/>
    </action>
  </state>

  <state name="PERSISTED_CRR" autorun="yes">
    <action name="export_crr"
	    resulting_state="SUCCESS">
      <condition name="ACL::export_crr"/>
    </action>
  </state>

  <state name="REJECTED" autorun="yes">
    <action name="null"
            resulting_state="FAILURE">
    </action>
  </state>

  <!-- failure and success states will be set by the import system -->

  <!-- ******************************************* -->
  <!--     this is the offline part of the CRR     -->
  <!-- ******************************************* -->

  <state name="INITIAL_IMPORT">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_REVOCATION_REQUEST_IMPORT</description>
    <action name="create_crr" 
	    resulting_state="IMPORTED_CRR">
      <condition name="ACL::import_crr"/>
      <condition name="Condition::server_0"/>
    </action>
  </state>

  <state name="IMPORTED_CRR" autorun="yes">
    <action name="revoke_certificate"
	    resulting_state="REVOKED_CERTIFICATE">
      <condition name="ACL::revoke_certificate"/>
    </action>
  </state>

  <state name="REVOKED_CERTIFICATE" autorun="yes">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_REVOCATION_REQUEST_REVOKED_CERTIFICATE</description>
    <action name="persist_crr"
	    resulting_state="SUCCESS">
      <condition name="ACL::insert_crr"/>
    </action>
  </state>

  <state name="FAILURE"/>
  <state name="SUCCESS" />
</workflow>
