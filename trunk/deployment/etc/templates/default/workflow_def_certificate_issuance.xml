<workflow>
<type>I18N_OPENXPKI_WF_TYPE_CERTIFICATE_ISSUANCE</type>
  <description>I18N_OPENXPKI_WF_DESC_CERTIFICATE_ISSUANCE</description>
  <persister>OpenXPKI</persister>
  <observer class="OpenXPKI::Server::Workflow::Observer::Debug"/>

  <state name="INITIAL">
    <action name="import"
            resulting_state="WAITING_FOR_START">
    </action>
  </state>

  <!-- this state is implicitly autostarted by the parent workflow -->
  <state name="WAITING_FOR_START">
    <action name="null" 
	    resulting_state="FAILURE">
      <condition name="!valid_csr_serial_present"/>
    </action>
    <action name="determine_issuing_ca"
	    resulting_state="ISSUING_CA_DETERMINED">
      <condition name="ACL::start_certificate_issuance"/>
      <condition name="valid_csr_serial_present"/>
    </action>
  </state>

  <state name="ISSUING_CA_DETERMINED" autorun="yes">
    <action name="do_nothing"
            resulting_state="CA_KEY_NOT_USABLE">
      <condition name="!ca_key_usable"/>
    </action>

    <action name="do_nothing2"
            resulting_state="CA_KEY_USABLE">
      <condition name="ca_key_usable"/>
    </action>
  </state>

  <state name="PREPARED" autorun="yes">
    <action name="issue_certificate" 
	    resulting_state="CERTIFICATE_ISSUED">
    </action>
  </state>

  <state name="CA_KEY_USABLE" autorun="yes">
    <action name="get_cert_profile"
            resulting_state="PREPARED">
    </action>
  </state>

  <state name="CA_KEY_NOT_USABLE">
    <action name="continue_issuance" 
	    resulting_state="CA_KEY_USABLE">
        <condition name="ca_key_usable"/>
    </action>
  </state>

  <state name="CERTIFICATE_ISSUED" autorun="yes">
    <action name="persist_certificate"
            resulting_state="SUCCESS">
    </action>
  </state>

  <state name="FAILURE"/>
  <state name="SUCCESS"/>
</workflow>
