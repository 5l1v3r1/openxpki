<workflow>
<type>I18N_OPENXPKI_WF_TYPE_CERTIFICATE_ISSUANCE</type>
  <description>I18N_OPENXPKI_WF_DESC_CERTIFICATE_ISSUANCE</description>
  <persister>OpenXPKI</persister>

  <state name="INITIAL">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_ISSUANCE_INITIAL</description>
    <action name="determine_issuing_ca" 
	    resulting_state="ISSUING_CA_DETERMINED">
      <condition name="ACL::start_certificate_issuance"/>
    </action>
    <!-- no 'required' field here because we want this WF to terminate with
	 an error immediately -->
    <!-- this is obsolete for now, as we pass on most of the data via
         the context and not via the DB -->
<!--
    <action name="null" 
	    resulting_state="FAILED">
      <condition name="CONTEXT::no_csr_serial_present"/>
    </action>
-->
  </state>
  
  <state name="ISSUING_CA_DETERMINED" autorun="yes">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_ISSUANCE_CA_DETERMINED</description>
    <action name="get_cert_profile" 
	    resulting_state="PREPARED">
    </action>
    
  </state>

  <state name="PREPARED" autorun="yes">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_ISSUANCE_PREPARED</description>
    <!-- for testing, assume CA key is always available 
    <action name="wait_for_ca"
	    resulting_state="PREPARED">
      <condition name="CA::key_is_not_usable"/>
    </action>
    -->
    <action name="issue_certificate" 
	    resulting_state="CERTIFICATE_ISSUED">
      <condition name="CA::key_is_usable"/>
    </action>
  </state>

  <state name="CERTIFICATE_ISSUED" autorun="yes">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_ISSUANCE_CERTIFICATE_ISSUED</description>
    <action name="insert_certificate"
            resulting_state="FINISHED">
    </action>
  </state>
  <state name="FINISHED"/>
  <state name="FAILED"/>

</workflow>
