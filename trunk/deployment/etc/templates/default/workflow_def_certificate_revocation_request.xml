<workflow>
  <type>I18N_OPENXPKI_WF_TYPE_CERTIFICATE_REVOCATION_REQUEST</type>
  <description>I18N_OPENXPKI_WF_DESC_CERTIFICATE_REVOCATION_REQUEST</description>
  <persister>OpenXPKI</persister>
  <observer class="OpenXPKI::Server::Workflow::Observer::Debug"/>


 <state name="INITIAL">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_REVOCATION_REQUEST_INITIAL</description>
    <action name="I18N_OPENXPKI_WF_ACTION_CRR_CREATE"
	    resulting_state="PENDING">
      <condition name="I18N_OPENXPKI_WF_ACL_CRR_CREATE"/>
    </action>
  </state>

  <state name="PENDING">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_REVOCATION_REQUEST_PENDING</description>
    <action name="I18N_OPENXPKI_WF_ACTION_CRR_CHANGE_INVALIDITY_TIME"
	    resulting_state="PENDING">
      <condition name="I18N_OPENXPKI_WF_ACL_CRR_CHANGE_INVALIDITY_TIME"/>
    </action>
    <action name="I18N_OPENXPKI_WF_ACTION_CRR_CHANGE_REASON"
	    resulting_state="PENDING">
      <condition name="I18N_OPENXPKI_WF_ACL_CRR_CHANGE_REASON"/>
    </action>
    <action name="I18N_OPENXPKI_WF_ACTION_CRR_APPROVE"
	    resulting_state="APPROVAL">
      <condition name="I18N_OPENXPKI_WF_ACL_CRR_APPROVE"/>
      <condition name="!I18N_OPENXPKI_WF_COND_IS_WORKFLOW_CREATOR"/>
    </action>
    <action name="I18N_OPENXPKI_WF_ACTION_CRR_REJECT"
	    resulting_state="REJECTED">
      <condition name="I18N_OPENXPKI_WF_ACL_CRR_REJECT"/>
    </action>
  </state>

  <state name="APPROVAL">
    <description>I18N_OPENXPKI_WF_STATE_CERTIFICATE_REVOCATION_REQUEST_APPROVAL</description>
    <action name="I18N_OPENXPKI_WF_ACTION_START_REVOCATION"
	    resulting_state="CRR_PERSIST">
      <condition name="I18N_OPENXPKI_WF_ACL_REVOKE_CERTIFICATE"/>
      <condition name="I18N_OPENXPKI_WF_COND_CHECK_CRR_APPROVALS"/>
    </action>
    <!-- perhaps we need more than one approval or                 -->
    <!-- perhaps the first approval was from a not authorized role -->
    <action name="I18N_OPENXPKI_WF_ACTION_CRR_APPROVE"
	    resulting_state="APPROVAL">
      <condition name="I18N_OPENXPKI_WF_ACL_CRR_APPROVE"/>
      <condition name="!workflow_creator"/>
    </action>
    <action name="I18N_OPENXPKI_WF_ACTION_CANCEL_APPROVAL"
	    resulting_state="PENDING">
      <condition name="I18N_OPENXPKI_WF_ACL_CRR_CANCEL_APPROVAL"/>
    </action>
    <action name="I18N_OPENXPKI_WF_ACTION_CRR_REJECT"
	    resulting_state="REJECTED">
      <condition name="I18N_OPENXPKI_WF_ACL_CRR_REJECT"/>
    </action>
  </state>
         
  <state name="CRR_PERSIST" autorun="yes">
    <action name="I18N_OPENXPKI_WF_ACTION_CRR_PERSIST"
	    resulting_state="NICE_DISPATCH_REVOKE">
          <condition name="I18N_OPENXPKI_WF_COND_CERTIFICATE_NOT_YET_REVOKED_OR_PENDING"/>
    </action>
    <action name="I18N_OPENXPKI_WF_ACTION_DO_NOTHING"
            resulting_state="FAILURE">
      <condition name="!I18N_OPENXPKI_WF_COND_CERTIFICATE_NOT_YET_REVOKED_OR_PENDING"/>
    </action>
  </state>
    
  <state name="NICE_DISPATCH_REVOKE" autorun="yes">    
    <action name="I18N_OPENXPKI_WF_ACTION_NICE_REVOKE_CERTIFICATE"
	    resulting_state="CHECK_FOR_REVOCATION" />          
  </state>
  

  <state name="CHECK_FOR_REVOCATION" autorun="yes">
   	<action name="I18N_OPENXPKI_WF_ACTION_DO_NOTHING"
            resulting_state="SUCCESS"> 
	     <condition name="!I18N_OPENXPKI_WF_COND_CERTIFICATE_REVOCATION_CRL_ISSUANCE_PENDING"/>
	     <condition name="!I18N_OPENXPKI_WF_COND_CERTIFICATE_NOT_YET_REVOKED" />
    </action>    
    <!-- Loop as long as the certificate is not revoked or max checks is reached -->
  	<action name="I18N_OPENXPKI_WF_ACTION_NICE_CHECK_FOR_REVOCATION"
  		resulting_state="CHECK_FOR_REVOCATION">
  		<condition name="I18N_OPENXPKI_WF_COND_CERTIFICATE_REVOCATION_CRL_ISSUANCE_PENDING"/>
  		<condition name="I18N_OPENXPKI_WF_COND_CHECK_FOR_REVOCATION_CHECKS_LEFT"/>
 	</action> 	
 	<!-- we are no longer in pending but also not revoked, so something is wrong -->
 	<!-- Might happen if we have hold/unhold and revoke workflows running in parallel  -->  	 	
 	<action name="I18N_OPENXPKI_WF_ACTION_DO_NOTHING2"
  		resulting_state="FAILURE">
		<condition name="!I18N_OPENXPKI_WF_COND_CHECK_FOR_REVOCATION_CHECKS_LEFT"/>
 	</action>
  </state>
 
  <state name="REJECTED" autorun="yes">
    <action name="I18N_OPENXPKI_WF_ACTION_DO_NOTHING"
            resulting_state="FAILURE">
    </action>
  </state>

  <state name="FAILURE"/>
  <state name="SUCCESS" />
</workflow>
