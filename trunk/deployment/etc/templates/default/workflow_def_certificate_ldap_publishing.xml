<workflow>

  <type>I18N_OPENXPKI_WF_TYPE_CERTIFICATE_LDAP_PUBLISHING</type>
  <description>I18N_OPENXPKI_WF_DESC_CERTIFICATE_LDAP_PUBLISHING</description>
  <persister>OpenXPKI</persister>

  <state name="INITIAL">
    <description>I18N_OPENXPKI_WF_STATE_LDAP_PUBLIC_INITIAL</description>
    <action name="I18N_OPENXPKI_WF_ACTION_CERTIFICATE_LDAP_PUBLISHING_IMPORT_PUBLIC_DATA" 
            resulting_state="WAITING_FOR_START">
    </action>
  </state>
  
  <!-- Do NOT set autorun as this will cause the parent (issue) process to hang until we finish
  	We need the new workflow engine to pick this up automatic -->
  <state name="WAITING_FOR_START">
    <description>I18N_OPENXPKI_WF_STATE_WAITING_FOR_START</description>
    <action name="I18N_OPENXPKI_WF_ACTION_DO_NOTHING"
             resulting_state="CHECK_DN_AVAILABLE">
		<condition name="I18N_OPENXPKI_WF_ACL_CERTIFICATE_LDAP_PUBLISHING"/>
   	</action>
  </state>

  <state name="CHECK_DN_AVAILABLE" autorun="yes">
    <description>I18N_OPENXPKI_WF_STATE_LDAP_CHECK_DN_AVAILABLE</description>
    <action name="I18N_OPENXPKI_WF_ACTION_DO_NOTHING"
	    resulting_state="ALL_NODES_PRESENT">
     <condition name="I18N_OPENXPKI_WF_COND_LDAP_DN_AVAILABLE"/> 
    </action>
    <action name="I18N_OPENXPKI_WF_ACTION_DO_NOTHING2"
	    resulting_state="ADD_NODE">
     <condition name="!I18N_OPENXPKI_WF_COND_LDAP_DN_AVAILABLE"/> 
    </action>
  </state>

  <state name="ADD_NODE" autorun="yes">
    <description>I18N_OPENXPKI_WF_STATE_LDAP_ADD_NODE</description>
    <action name="I18N_OPENXPKI_WF_ACTION_CERTIFICATE_LDAP_PUBLISHING_ADD_MISSING_NODE"
	    resulting_state="ALL_NODES_PRESENT">
    </action>
  </state>

  <state name="ALL_NODES_PRESENT" autorun="yes">
    <description>I18N_OPENXPKI_WF_STATE_LDAP_ALL_NODES_PRESENT</description>
    <action name="I18N_OPENXPKI_WF_ACTION_CERTIFICATE_LDAP_PUBLISHING_PUBLISH"
             resulting_state="SUCCESS">
    </action>
  </state>

  <state name="SUCCESS"/>

</workflow>
