<!-- 
  Generated by: tools/scripts/ogflow.pl 

     File: core/config/graffle/workflow_enrollment.graffle
      md5: 225771fdb669ea1b1bd0382cb91b6a3e

-->


<conditions>

    <condition name="enroll_valid_request"
            class="Workflow::Condition::LazyAND">
        <param name="condition3" value="enroll_signer_cert_active" />
        <param name="condition5" value="enroll_transaction_id_given" />
        <param name="condition6" value="enroll_signer_cert_crypt_ok" />
        <param name="condition2" value="enroll_valid_csr" />
    </condition>

    <condition name="enroll_signer_cert_crypt_ok"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{signer_signature_valid} == 1;" />
    </condition>

    <condition name="enroll_valid_csr"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="length($context-&gt;{cert_subject});" />
    </condition>

    <condition name="enroll_transaction_id_given"
            class="OpenXPKI::Server::Workflow::Condition::SCEPv2::ValidSCEPTID">
    </condition>

    <condition name="enroll_have_all_approvals"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{have_all_approvals};" />
    </condition>

    <condition name="enroll_allow_manual_approval"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{p_allow_man_approv};" />
    </condition>

    <condition name="enroll_trusted_self_sign"
            class="Workflow::Condition::LazyAND">
        <param name="condition2" value="enroll_trusted_self_sign_details" />
        <param name="condition1" value="enroll_signer_sn_matches_csr" />
    </condition>

    <condition name="enroll_valid_challenge_password"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="not not $context-&gt;{valid_chall_pass}" />
    </condition>

    <condition name="enroll_valid_kerberos_authentication"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{valid_kerb_authen}" />
    </condition>

    <condition name="enroll_ca_key_usable"
            class="OpenXPKI::Server::Workflow::Condition::Key">
        <param name="key" value="ca" />
        <param name="status" value="usable" />
    </condition>

    <condition name="enroll_num_active_certs_less_than_max_active_certs"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{num_active_certs} &lt; $context-&gt;{p_max_active_certs};" />
    </condition>

    <condition name="enroll_use_ldap"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="1 == 1" />
    </condition>

    <condition name="enroll_signer_cert_active"
            class="Workflow::Condition::LazyOR">
        <param name="condition2" value="enroll_signer_validity_ok" />
        <param name="condition1" value="enroll_allow_expired_signer" />
        <param name="condition3" value="enroll_self_signed_initial_enroll" />
    </condition>

    <condition name="enroll_allow_expired_signer"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{p_allow_expired_signer};" />
    </condition>

    <condition name="enroll_policy_allows_anon_enroll"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{p_allow_anon_enroll}" />
    </condition>

    <condition name="enroll_signer_validity_ok"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{signer_validity_ok};" />
    </condition>

    <condition name="enroll_trusted_signer_on_behalf"
            class="Workflow::Condition::LazyAND">
        <param name="condition1" value="enroll_signer_trusted" />
        <param name="condition2" value="enroll_signer_on_behalf" />
    </condition>

    <condition name="enroll_signer_sn_matches_csr"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="not not $context-&gt;{signer_sn_matches_csr}" />
    </condition>

    <condition name="enroll_trusted_initial_enroll"
            class="Workflow::Condition::LazyOR">
        <param name="condition1" value="enroll_trusted_self_sign" />
        <param name="condition2" value="enroll_trusted_signer_on_behalf" />
    </condition>

    <condition name="enroll_ca_policy_approval"
            class="Workflow::Condition::LazyAND">
        <param name="condition2" value="enroll_at_least_one_active_cert" />
        <param name="condition1" value="enroll_active_cert_count_ok" />
    </condition>

    <condition name="enroll_num_active_certs_less_than_max"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{num_active_certs} &lt; $context-&gt;{p_max_active_certs}" />
    </condition>

    <condition name="enroll_in_renewal_window"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="($context-&gt;{num_active_certs} &lt;= $context-&gt;{p_max_active_certs}) and $context-&gt;{in_renew_window}" />
    </condition>

    <condition name="enroll_in_replace_window"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="($context-&gt;{num_active_certs} &lt;= $context-&gt;{p_max_active_certs})  and $context-&gt;{in_replace_window} and $context-&gt;{renewal_mode} eq 'replace'" />
    </condition>
    
    <condition name="enroll_signed_renewal"
            class="Workflow::Condition::LazyAND">
        <param name="condition1" value="enroll_signer_trusted" />
        <param name="condition2" value="enroll_signer_sn_matches_csr" />
    </condition>

    <condition name="enroll_tmp_queue_is_empty"
            class="OpenXPKI::Server::Workflow::Condition::WFArray">
        <param name="array_name" value="tmp_queue" />
        <param name="condition" value="is_empty" />
    </condition>

    <condition name="enroll_auto_revoke_existing_certs"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{p_auto_revoke_existing_certs}" />
    </condition>

    <condition name="enroll_signer_on_behalf"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="not not $context-&gt;{signer_on_behalf}" />
    </condition>

    <condition name="enroll_active_cert_count_ok"
            class="Workflow::Condition::LazyOR">
        <param name="condition1" value="enroll_num_active_certs_less_than_max" />
        <param name="condition2" value="enroll_in_renewal_window" />
        <param name="condition2" value="enroll_in_replace_window" />
    </condition>

    <condition name="enroll_trusted_self_sign_details"
            class="Workflow::Condition::LazyOR">
        <param name="condition1" value="enroll_valid_challenge_password" />
        <param name="condition3" value="enroll_policy_allows_anon_enroll" />
        <param name="condition2" value="enroll_valid_kerberos_authentication" />
    </condition>

    <condition name="enroll_at_least_one_active_cert"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{num_active_certs} &gt; 0" />
    </condition>

    <condition name="enroll_have_challenge_password"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="defined $context-&gt;{_challenge_password};" />
    </condition>

    <condition name="enroll_signer_trusted"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{signer_trusted};" />
    </condition>

    <condition name="enroll_self_signed_initial_enroll"
            class="Workflow::Condition::LazyAND">
        <param name="condition2" value="enroll_signer_sn_matches_csr" />
        <param name="condition3" value="enroll_signer_is_self_signed" />
    </condition>

    <condition name="enroll_signer_is_self_signed"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{signer_is_self_signed};" />
    </condition>

    <condition name="enroll_allow_manual_authentication"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{p_allow_man_authen};" />
    </condition>

    <condition name="enroll_key_policy_ok"
            class="Workflow::Condition::LazyAND">
        <param name="condition2" value="enroll_csr_key_type_ok" />
        <param name="condition1" value="enroll_csr_key_size_ok" />
        <param name="condition3" value="enroll_csr_hash_type_ok" />
    </condition>

    <condition name="enroll_csr_key_size_ok"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{csr_key_size_ok};" />
    </condition>

    <condition name="enroll_csr_key_type_ok"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{csr_key_type_ok};" />
    </condition>

    <condition name="enroll_csr_hash_type_ok"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{csr_hash_type_ok};" />
    </condition>


    <condition name="enroll_need_revoke_after_replace"
            class="Workflow::Condition::Evaluate">
        <param name="test" value="$context-&gt;{replace_cert_identifier};" />
    </condition>

</conditions>
